
import type { SchoolClass, Adjustment, TimetableGridData, DownloadLanguage, DownloadDesignConfig, Teacher, SchoolConfig, Subject, PeriodTime, Break, Period, LeaveDetails, AttendanceData, TriangleCorner } from '../types';
import { translations } from '../i18n';
import { allDays } from '../types';

export interface WorkloadStats {
  dailyCounts: { [key: string]: number };
  weeklyPeriods: number;
  jointPeriodsCount: number;
  substitutionsTaken: number;
  leavesTaken: number;
  totalWorkload: number;
  // New properties for Range Calculation
  daysInRange?: number;
  scheduledInRange?: number;
  rangeLeaves?: number;
  rangeSubs?: number;
  netLoad?: number;
  possiblePeriodsInRange?: number;
}

const URDU_FONT_STACK = "'Gulzar', 'Noto Nastaliq Urdu', serif";

const teacherColorNames = [
  'subject-sky', 'subject-green', 'subject-yellow', 'subject-red',
  'subject-purple', 'subject-pink', 'subject-indigo', 'subject-teal',
  'subject-orange', 'subject-lime', 'subject-cyan', 'subject-emerald',
  'subject-fuchsia', 'subject-rose', 'subject-amber', 'subject-blue', 'subject-indigo'
];

const renderText = (lang: DownloadLanguage, en: string, ur: string) => {
    const urduStyle = `font-family: ${URDU_FONT_STACK} !important; direction: rtl; unicode-bidi: embed; line-height: 1.8; display: inline-block; padding-top: 2px; font-weight: normal;`;
    const urduSpan = `<span class="font-urdu" style="${urduStyle}">${ur}</span>`;
    
    if (lang === 'en') return en;
    if (lang === 'ur') return urduSpan;
    return `<div style="display:flex; flex-direction:column; justify-content:center; align-items:center; line-height:1.1;"><span>${en}</span><span style="${urduStyle} font-size: 0.85em;">${ur}</span></div>`;
};

// --- CSV Helper Functions ---
const downloadCsv = (content: string, filename: string) => {
    const blob = new Blob([`\uFEFF${content}`], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

const toCsvRow = (cells: any[]) => cells.map(c => {
    const str = String(c === undefined || c === null ? '' : c);
    if (str.search(/("|,|\n)/g) >= 0) {
        return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
}).join(',');

const isDateInVacation = (dateStr: string, session?: any) => {
    if (!session || !session.vacations) return false;
    const d = new Date(dateStr);
    return session.vacations.some((v: any) => {
        const start = new Date(v.startDate);
        const end = new Date(v.endDate);
        return d >= start && d <= end;
    });
};

export const calculateWorkloadStats = (
    teacherId: string, 
    classes: SchoolClass[], 
    adjustments: Record<string, Adjustment[]> = {},
    leaveDetails: Record<string, Record<string, LeaveDetails>> = {},
    startDate?: string,
    endDate?: string,
    schoolConfig?: SchoolConfig,
    sessionData?: any
): WorkloadStats => {
    const dailyCounts: { [key: string]: number } = {};
    allDays.forEach(day => dailyCounts[day.toLowerCase()] = 0);
    
    let weeklyPeriods = 0;
    let jointPeriodsCount = 0;

    allDays.forEach(day => {
        const dayKey = day as keyof TimetableGridData;
        
        if (schoolConfig && schoolConfig.daysConfig && !schoolConfig.daysConfig[dayKey]?.active) {
            return; 
        }

        for (let i = 0; i < 12; i++) {
            const periodsInSlot: Period[] = [];
            
            classes.forEach(c => {
                const slot = c.timetable[dayKey]?.[i];
                if (slot) {
                    slot.forEach(p => {
                        if (p.teacherId === teacherId) {
                            periodsInSlot.push(p);
                        }
                    });
                }
            });

            if (periodsInSlot.length > 0) {
                const processedJointIds = new Set<string>();
                
                periodsInSlot.forEach(p => {
                    if (p.jointPeriodId) {
                        if (!processedJointIds.has(p.jointPeriodId)) {
                            dailyCounts[day.toLowerCase()]++;
                            weeklyPeriods++;
                            jointPeriodsCount++; 
                            processedJointIds.add(p.jointPeriodId);
                        }
                    } else {
                        dailyCounts[day.toLowerCase()]++;
                        weeklyPeriods++;
                    }
                });
            }
        }
    });

    const datesToCheck: string[] = [];
    if (startDate && endDate) {
        let curr = new Date(startDate);
        const end = new Date(endDate);
        while (curr <= end) {
            const dStr = curr.toISOString().split('T')[0];
            if (!isDateInVacation(dStr, sessionData)) {
                datesToCheck.push(dStr);
            }
            curr.setDate(curr.getDate() + 1);
        }
    } else {
        const keys = new Set([...Object.keys(adjustments), ...Object.keys(leaveDetails)]);
        Array.from(keys).forEach(dStr => {
             if (!isDateInVacation(dStr, sessionData)) {
                datesToCheck.push(dStr);
            }
        });
    }

    let substitutionsTaken = 0;
    let leavesTaken = 0;

    datesToCheck.forEach(date => {
        const d = new Date(date);
        const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const dayIndex = d.getDay();
        const dayName = dayMap[dayIndex] as keyof TimetableGridData;
        
        if (!allDays.includes(dayName)) return;
        
        if (schoolConfig && schoolConfig.daysConfig && !schoolConfig.daysConfig[dayName]?.active) {
            return;
        }

        const dayAdjustments = adjustments[date] || [];
        const teacherLeave = leaveDetails[date]?.[teacherId];
        const isOnDuty = teacherLeave?.reason === 'On Duty';

        const subSlots = new Set<number>();
        dayAdjustments.forEach(adj => {
            if (adj.substituteTeacherId === teacherId) {
                subSlots.add(adj.periodIndex);
            }
        });
        substitutionsTaken += subSlots.size;

        if (isOnDuty) return;

        for (let i = 0; i < 12; i++) {
             const periodsInSlot: Period[] = [];
             classes.forEach(c => {
                 c.timetable[dayName]?.[i]?.forEach(p => {
                     if (p.teacherId === teacherId) periodsInSlot.push(p);
                 });
             });

             if (periodsInSlot.length === 0) continue;

             const processedJointIds = new Set<string>();
             
             periodsInSlot.forEach(p => {
                 let isLoadUnit = false;
                 if (p.jointPeriodId) {
                     if (!processedJointIds.has(p.jointPeriodId)) {
                         isLoadUnit = true;
                         processedJointIds.add(p.jointPeriodId);
                     }
                 } else {
                     isLoadUnit = true;
                 }

                 if (isLoadUnit) {
                     let isMissed = false;
                     
                     if (teacherLeave) {
                         if (teacherLeave.leaveType === 'full') {
                             isMissed = true;
                         } else if (teacherLeave.leaveType === 'half') {
                             if (teacherLeave.periods && teacherLeave.periods.length > 0) {
                                 isMissed = teacherLeave.periods.includes(i + 1);
                             } else if ((i + 1) >= teacherLeave.startPeriod) {
                                 isMissed = true;
                             }
                         }
                     }

                     if (!isMissed) {
                         const subOut = dayAdjustments.some(adj => 
                             adj.originalTeacherId === teacherId &&
                             adj.periodIndex === i &&
                             adj.classId === p.classId
                         );
                         if (subOut) isMissed = true;
                     }

                     if (isMissed) {
                         leavesTaken++;
                     }
                 }
             });
        }
    });

    const totalWorkload = weeklyPeriods + substitutionsTaken - leavesTaken;

    return {
        dailyCounts,
        weeklyPeriods,
        jointPeriodsCount,
        substitutionsTaken,
        leavesTaken,
        totalWorkload
    };
};

export const getPrintStyles = (design: DownloadDesignConfig) => {
    const page = design?.page || { size: 'a4', orientation: 'portrait', margins: { top: 10, right: 10, bottom: 10, left: 10 }, watermarkOpacity: 0.1 };
    const table = design?.table || { cardStyle: 'full', triangleCorner: 'bottom-left', fontFamily: 'sans-serif', fontSize: 14, cellPadding: 8, borderColor: '#000000', borderWidth: 1, gridStyle: 'solid', headerBgColor: '#f3f4f6', headerColor: '#000000', bodyBgColor: '#ffffff', bodyColor: '#000000', altRowColor: '#f9fafb', periodColumnWidth: 50, periodColumnBgColor: '#f3f4f6', periodColumnColor: '#000000', outlineWidth: 2 };
    const header = design?.header || { divider: true, bgColor: 'transparent' };
    const footer = design?.footer || { fontFamily: 'sans-serif', fontSize: 10, color: '#000000' };

    const width = page.orientation === 'portrait' ? (page.size === 'legal' ? '816px' : '794px') : (page.size === 'legal' ? '1344px' : '1123px');
    const height = page.orientation === 'portrait' ? (page.size === 'legal' ? '1344px' : '1123px') : (page.size === 'legal' ? '816px' : '794px');

    const importsLatin = `@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Gulzar&family=Noto+Nastaliq+Urdu:wght@400;700&family=Anton&family=Antonio:wght@400;700&family=Bebas+Neue&family=Bodoni+Moda:opsz,wght@6..96,400..900&family=Bungee+Spice&family=Fjalla+One&family=Instrument+Serif:ital@0;1&family=Lato:wght@400;700&family=Merriweather:wght@400;700;900&family=Monoton&family=Montserrat:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Orbitron:wght@400;700&family=Oswald:wght@400;700&family=Anton&family=Instrument+Serif:ital@0;1&family=Playwrite+CU:wght@100..400&family=Roboto:wght@400;500;700&family=Rubik+Mono+One&display=swap');`;

    const vAlign = (table.verticalAlign as string) === 'center' ? 'middle' : (table.verticalAlign || 'top'); 

    const cardStyle = table.cardStyle || 'full';
    const triangleCorner = table.triangleCorner || 'bottom-left';
    const outlineWidth = table.outlineWidth || 2;
    
    let triangleStyles = '';
    const triangleSize = 24; 
    if (triangleCorner === 'top-left') {
        triangleStyles = `top: 0; left: 0; border-top: ${triangleSize}px solid currentColor; border-right: ${triangleSize}px solid transparent;`;
    } else if (triangleCorner === 'top-right') {
        triangleStyles = `top: 0; right: 0; border-top: ${triangleSize}px solid currentColor; border-left: ${triangleSize}px solid transparent;`;
    } else if (triangleCorner === 'bottom-right') {
        triangleStyles = `bottom: 0; right: 0; border-bottom: ${triangleSize}px solid currentColor; border-left: ${triangleSize}px solid transparent;`;
    } else { // bottom-left default
        triangleStyles = `bottom: 0; left: 0; border-bottom: ${triangleSize}px solid currentColor; border-right: ${triangleSize}px solid transparent;`;
    }

    let cardSpecificStyles = '';
    if (cardStyle === 'outline') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background-color: #ffffff !important; border-width: ${outlineWidth}px !important; border-style: solid !important; box-shadow: none !important; border-color: inherit !important; color: inherit !important; }
            .subject-text, .teacher-text, .class-list, .subject-name { color: inherit !important; text-shadow: none !important; }
        `;
    } else if (cardStyle === 'text') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background-color: #ffffff !important; border-color: transparent !important; box-shadow: none !important; color: inherit !important; }
            .subject-text, .teacher-text, .class-list, .subject-name { color: inherit !important; text-shadow: none !important; }
        `;
    } else if (cardStyle === 'triangle') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background-color: #ffffff !important; border-color: transparent !important; box-shadow: none !important; position: relative; overflow: hidden; color: inherit !important; }
            .card-triangle { position: absolute; width: 0; height: 0; border-style: solid; ${triangleStyles} z-index: 5; }
            .subject-text, .teacher-text, .class-list, .subject-name { color: inherit !important; text-shadow: none !important; position: relative; z-index: 10; }
        `;
    } else if (cardStyle === 'glass') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background: rgba(255, 255, 255, 0.5) !important; backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important; }
            .subject-text, .subject-name { color: inherit !important; text-shadow: none !important; font-weight: 900 !important; }
        `;
    } else if (cardStyle === 'gradient') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.1) 100%) !important; box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important; border: none !important; }
            .subject-text, .subject-name { text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important; }
        `;
    } else if (cardStyle === 'minimal-left') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background-color: #f8fafc !important; border-left: 5px solid currentColor !important; border-top: none !important; border-right: none !important; border-bottom: none !important; box-shadow: none !important; border-radius: 2px !important; }
        `;
    } else if (cardStyle === 'badge') {
        cardSpecificStyles = `
            .glossy-box, .teacher-card { background-color: transparent !important; border: none !important; box-shadow: none !important; }
            .subject-text, .subject-name { background-color: currentColor; color: #fff !important; padding: 2px 8px; border-radius: 12px; display: inline-block; font-size: 0.9em !important; }
        `;
    } else {
        // Full color base
        cardSpecificStyles = `
            .glossy-box, .teacher-card { position: relative; overflow: hidden; }
            .card-triangle { position: absolute; width: 0; height: 0; border-style: solid; ${triangleStyles} z-index: 5; opacity: 0.4; }
        `;
    }

    return `
    ${importsLatin}
    
    .print-container {
      background-color: white;
      color: inherit;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      font-family: '${table.fontFamily}', sans-serif; 
    }

    .print-container .font-urdu, 
    .print-container .font-urdu * {
        font-family: ${URDU_FONT_STACK} !important;
        line-height: 1.8;
        padding-top: 2px;
        direction: rtl;
        font-synthesis: none;
        font-weight: normal; 
    }
    
    .page { 
        width: ${width}; 
        height: ${height}; 
        padding: ${page.margins.top}mm ${page.margins.right}mm ${page.margins.bottom}mm ${page.margins.left}mm; 
        display: flex; 
        flex-direction: column; 
        position: relative; 
        box-sizing: border-box; 
        background: white; 
        overflow: hidden; 
    }
    
    .content-wrapper { position: relative; z-index: 10; display: flex; flex-direction: column; flex-grow: 1; height: 100%; }
    .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 60%; object-fit: contain; opacity: ${page.watermarkOpacity}; z-index: 0; pointer-events: none; }
    
    .header-container { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        margin-bottom: 10px; 
        padding-bottom: 8px;
        border-bottom: ${header.divider ? '3px double #000' : 'none'};
        background-color: ${header.bgColor};
        flex-shrink: 0;
    }
    .header-logo { object-fit: contain; }
    .header-text { flex-grow: 1; }
    .header-school-name { margin: 0; line-height: 1.2; text-transform: uppercase; white-space: nowrap; }
    .header-title { margin-top: 4px; letter-spacing: 0.5px; }
    .header-details { margin-top: 4px; display: flex; justify-content: space-between; }

    .main-content { flex-grow: 1; display: flex; flex-direction: column; font-size: ${table.fontSize}px; overflow: hidden; }

    .footer { 
        margin-top: auto; 
        padding-top: 5px; 
        border-top: 1px solid #000; 
        display: flex; 
        align-items: flex-end; 
        font-family: '${footer.fontFamily}', sans-serif;
        font-size: ${footer.fontSize}px; 
        color: ${footer.color};
        flex-shrink: 0;
    }
    
    table { width: 100%; border-collapse: collapse; margin-bottom: 0; border: ${table.borderWidth || 1}px ${table.gridStyle || 'solid'} ${table.borderColor}; }
    th, td { 
        border: ${table.borderWidth || 1}px ${table.gridStyle || 'solid'} ${table.borderColor}; 
        padding: ${table.cellPadding}px; 
        vertical-align: ${vAlign} !important; 
        text-align: center; 
        font-size: ${table.fontSize}px;
        color: ${table.bodyColor || '#000000'};
        font-family: '${table.fontFamily}', sans-serif;
        line-height: 1.1; 
        box-sizing: border-box;
        overflow: visible !important;
        position: relative;
        z-index: 1;
        background-clip: padding-box;
        letter-spacing: normal;
    }
    th { 
        background-color: ${table.headerBgColor}; 
        color: ${table.headerColor};
        font-weight: bold; 
        font-size: ${table.headerFontSize || table.fontSize}px;
    }
    tr:nth-child(even) { background-color: ${table.altRowColor}; }
    .period-col {
        width: ${table.periodColumnWidth}px;
        background-color: ${table.periodColumnBgColor};
        color: ${table.periodColumnColor};
        font-weight: bold;
        font-size: 1.2em;
    }

    ${cardSpecificStyles}

    /* Theme color mapping for triangles */
    ${teacherColorNames.map(name => `
        .${name} { background-color: var(--${name}-bg); color: var(--${name}-text); border-color: var(--${name}-text) !important; }
        .${name} .subject-text, .${name} .teacher-text, .${name} .subject-name, .${name} .class-list { color: var(--${name}-text) !important; }
        .${name} .card-triangle { 
            color: var(--${name}-text) !important;
        }
    `).join('')}
    `;
};

const generateReportHTML = (
    schoolConfig: SchoolConfig,
    design: DownloadDesignConfig,
    title: string,
    lang: DownloadLanguage,
    content: string,
    details?: string,
    pageNumber?: number,
    totalPages?: number
): string => {
    const styles = getPrintStyles(design);
    const logoHtml = design.header.showLogo && schoolConfig.schoolLogoBase64
        ? `<img src="${schoolConfig.schoolLogoBase64}" class="header-logo" style="height: ${design.header.logoSize}px" />`
        : '';
    
    const showPageNum = design.footer.includePageNumber && pageNumber !== undefined && totalPages !== undefined;
    const pageNumHtml = showPageNum ? `<span>Page ${pageNumber} of ${totalPages}</span>` : '';

    return `
        <div class="print-container">
            <style>${styles}</style>
            <div class="page">
                ${schoolConfig.schoolLogoBase64 && design.page.watermarkOpacity > 0 ? `<img src="${schoolConfig.schoolLogoBase64}" class="watermark" />` : ''}
                <div class="content-wrapper">
                    <header class="header-container" style="justify-content: ${design.header.logoPosition === 'center' ? 'center' : design.header.logoPosition === 'right' ? 'flex-end' : 'flex-start'}">
                        ${design.header.logoPosition === 'left' ? logoHtml : ''}
                        <div class="header-text" style="text-align: ${design.header.schoolName.align}">
                            <h1 class="header-school-name" style="font-family: '${design.header.schoolName.fontFamily}'; font-size: ${design.header.schoolName.fontSize}px; font-weight: ${design.header.schoolName.fontWeight}; color: ${design.header.schoolName.color}">
                                ${lang === 'ur' ? schoolConfig.schoolNameUr : schoolConfig.schoolNameEn}
                            </h1>
                            ${design.header.showTitle ? `<h2 class="header-title" style="font-family: '${design.header.title.fontFamily}'; font-size: ${design.header.title.fontSize}px; font-weight: ${design.header.title.fontWeight}; color: ${design.header.title.color}; text-align: ${design.header.title.align}">${title}</h2>` : ''}
                            ${details ? `<div class="header-details" style="font-family: '${design.header.details.fontFamily}'; font-size: ${design.header.details.fontSize}px; font-weight: ${design.header.details.fontWeight}; color: ${design.header.details.color}; text-align: ${design.header.details.align}">${details}</div>` : ''}
                        </div>
                        ${design.header.logoPosition === 'right' ? logoHtml : ''}
                    </header>
                    <main class="main-content">
                        ${content}
                    </main>
                    ${design.footer.show ? `
                    <footer class="footer" style="justify-content: ${design.footer.align === 'center' ? 'center' : design.footer.align === 'right' ? 'flex-end' : 'flex-start'}">
                        <div style="flex: 1; text-align: left;">${design.footer.includeTimestamp ? new Date().toLocaleString() : ''}</div>
                        <div style="flex: 2; text-align: center;">${design.footer.text}</div>
                        <div style="flex: 1; text-align: right;">${pageNumHtml}</div>
                    </footer>` : ''}
                </div>
            </div>
        </div>
    `;
};

export const generateBasicInformationHtml = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, classes: SchoolClass[], teachers: Teacher[], schoolConfig: SchoolConfig): string => {
    const title = lang === 'ur' ? translations.ur.basicInformation : translations.en.basicInformation;
    
    // Classes Table
    let classesTable = `<h3>Classes</h3><table><thead><tr><th>Name</th><th>In-Charge</th><th>Room</th><th>Students</th></tr></thead><tbody>`;
    classes.forEach(c => {
        const teacher = teachers.find(t => t.id === c.inCharge);
        classesTable += `<tr><td>${renderText(lang, c.nameEn, c.nameUr)}</td><td>${teacher ? renderText(lang, teacher.nameEn, teacher.nameUr) : '-'}</td><td>${c.roomNumber}</td><td>${c.studentCount}</td></tr>`;
    });
    classesTable += `</tbody></table>`;

    // Teachers Table
    let teachersTable = `<h3>Teachers</h3><table><thead><tr><th>Name</th><th>Contact</th><th>Serial #</th></tr></thead><tbody>`;
    teachers.forEach(t => {
        teachersTable += `<tr><td>${renderText(lang, t.nameEn, t.nameUr)}</td><td>${t.contactNumber}</td><td>${t.serialNumber || '-'}</td></tr>`;
    });
    teachersTable += `</tbody></table>`;

    return generateReportHTML(schoolConfig, design, title, lang, classesTable + '<br/>' + teachersTable);
};

export const generateBasicInformationExcel = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, classes: SchoolClass[], teachers: Teacher[]) => {
    const classRows = classes.map(c => {
        const teacher = teachers.find(t => t.id === c.inCharge);
        return {
            Type: 'Class',
            Name: lang === 'ur' ? c.nameUr : c.nameEn,
            InCharge: teacher ? (lang === 'ur' ? teacher.nameUr : teacher.nameEn) : '-',
            Room: c.roomNumber,
            Count: c.studentCount
        };
    });
    const teacherRows = teachers.map(t => ({
        Type: 'Teacher',
        Name: lang === 'ur' ? t.nameUr : t.nameEn,
        InCharge: t.contactNumber,
        Room: t.serialNumber,
        Count: ''
    }));
    
    const csv = ['Type,Name,Detail 1,Detail 2,Detail 3'];
    [...classRows, ...teacherRows].forEach(r => {
        csv.push(toCsvRow([r.Type, r.Name, r.InCharge, r.Room, r.Count]));
    });
    downloadCsv(csv.join('\n'), 'Basic_Information.csv');
};

export const generateByPeriodHtml = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, schoolConfig: SchoolConfig, classes: SchoolClass[], teachers: Teacher[]): string => {
    const title = lang === 'ur' ? translations.ur.byPeriod : translations.en.byPeriod;
    const activeDays = allDays.filter(day => schoolConfig.daysConfig?.[day]?.active ?? true);
    
    let content = '';
    
    activeDays.forEach(day => {
        const periodCount = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
        content += `<h3>${day}</h3><table><thead><tr><th>Period</th><th>Free Teachers</th></tr></thead><tbody>`;
        
        for (let i = 0; i < periodCount; i++) {
            const freeTeachers = teachers.filter(t => {
                // check if teacher is assigned to any class in this period
                return !classes.some(c => c.timetable[day]?.[i]?.some(p => p.teacherId === t.id));
            });
            
            const names = freeTeachers.map(t => renderText(lang, t.nameEn, t.nameUr)).join(', ');
            content += `<tr><td>${i + 1}</td><td>${names}</td></tr>`;
        }
        content += `</tbody></table><br/>`;
    });

    return generateReportHTML(schoolConfig, design, title, lang, content);
};

export const generateByPeriodExcel = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, schoolConfig: SchoolConfig, classes: SchoolClass[], teachers: Teacher[]) => {
    const activeDays = allDays.filter(day => schoolConfig.daysConfig?.[day]?.active ?? true);
    const csv = ['Day,Period,Free Teachers'];
    
    activeDays.forEach(day => {
        const periodCount = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
        for (let i = 0; i < periodCount; i++) {
            const freeTeachers = teachers.filter(t => !classes.some(c => c.timetable[day]?.[i]?.some(p => p.teacherId === t.id)));
            const names = freeTeachers.map(t => lang === 'ur' ? t.nameUr : t.nameEn).join(', ');
            csv.push(toCsvRow([day, i + 1, names]));
        }
    });
    downloadCsv(csv.join('\n'), 'Free_Teachers.csv');
};

export const generateWorkloadSummaryHtml = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, teachers: Teacher[], schoolConfig: SchoolConfig, classes: SchoolClass[], adjustments: Record<string, Adjustment[]>, leaveDetails: any, startDate: string, endDate: string, mode: string): string => {
    const title = lang === 'ur' ? translations.ur.workloadSummaryReport : translations.en.workloadSummaryReport;
    const headers = `<tr><th>Teacher</th><th>Total</th><th>Subst.</th><th>Leaves</th><th>Net</th></tr>`;
    
    let rows = '';
    teachers.forEach(teacher => {
        const stats = calculateWorkloadStats(teacher.id, classes, adjustments, leaveDetails, startDate, endDate, schoolConfig);
        const name = renderText(lang, teacher.nameEn, teacher.nameUr);
        // Net load = scheduled + substitutions - leaves
        const net = stats.weeklyPeriods + stats.substitutionsTaken - stats.leavesTaken; 
        rows += `<tr><td>${name}</td><td>${stats.weeklyPeriods}</td><td>${stats.substitutionsTaken}</td><td>${stats.leavesTaken}</td><td>${net}</td></tr>`;
    });

    const table = `<table><thead>${headers}</thead><tbody>${rows}</tbody></table>`;
    return generateReportHTML(schoolConfig, design, title, lang, table, `Date: ${startDate} to ${endDate}`);
};

export const generateWorkloadSummaryExcel = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, teachers: Teacher[], schoolConfig: SchoolConfig, classes: SchoolClass[], adjustments: Record<string, Adjustment[]>, leaveDetails: any, startDate: string, endDate: string, mode: string) => {
    const csv = ['Teacher,Total Scheduled,Substitutions,Leaves,Net Load'];
    teachers.forEach(teacher => {
        const stats = calculateWorkloadStats(teacher.id, classes, adjustments, leaveDetails, startDate, endDate, schoolConfig);
        const name = lang === 'ur' ? teacher.nameUr : teacher.nameEn;
        const net = stats.weeklyPeriods + stats.substitutionsTaken - stats.leavesTaken;
        csv.push(toCsvRow([name, stats.weeklyPeriods, stats.substitutionsTaken, stats.leavesTaken, net]));
    });
    downloadCsv(csv.join('\n'), 'Workload_Summary.csv');
};

export const generateSchoolTimingsHtml = (t: any, lang: DownloadLanguage, design: DownloadDesignConfig, schoolConfig: SchoolConfig): string => {
    const customDesign = JSON.parse(JSON.stringify(design));
    customDesign.footer.includePageNumber = false; 
    customDesign.header.showTitle = true;

    if (lang === 'ur') {
        customDesign.header.title.align = 'right';
        customDesign.header.schoolName.align = 'right';
    }

    const isUrdu = lang === 'ur';
    const urduStyle = `font-family: ${URDU_FONT_STACK} !important; direction: rtl; unicode-bidi: embed; line-height: 1.8; font-weight: normal;`;
    const alignMap: Record<string, string> = { 'top': 'flex-start', 'middle': 'center', 'bottom': 'flex-end', 'center': 'center' };
    const flexAlign = alignMap[customDesign.table.verticalAlign || 'middle'] || 'center';
    const trLocal = (en: string, ur: string) => { const urSpan = `<span class="font-urdu" style="${urduStyle}">${ur}</span>`; if (lang === 'en') return en; if (lang === 'ur') return urSpan; return `${en} / ${urSpan}`; };
    const num = (n: string | number) => n.toString();
    const timeStr = (t: PeriodTime) => { if (!t.start || !t.end) return ''; return `${t.start} - ${t.end}`; };
    const getDuration = (start: string, end: string) => { if (!start || !end) return 0; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); const d1 = new Date(2000, 0, 1, h1, m1); const d2 = new Date(2000, 0, 1, h2, m2); return Math.round((d2.getTime() - d1.getTime()) / 60000); };
    
    const getMaxPeriods = (type: 'default' | 'friday') => {
        const daysToCheck = type === 'friday' ? ['Friday'] : ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Saturday'];
        let max = 0;
        daysToCheck.forEach(d => {
            // @ts-ignore
            const cfg = schoolConfig.daysConfig[d];
            if (cfg && cfg.active) {
                max = Math.max(max, cfg.periodCount);
            }
        });
        return max > 0 ? max : 8;
    };

    const getScheduleItems = (type: 'default' | 'friday') => { 
        const periods = schoolConfig.periodTimings[type]; 
        const breaks = schoolConfig.breaks[type]; 
        const assembly = schoolConfig.assembly[type]; 
        const maxPeriods = getMaxPeriods(type);

        const items: { type: 'assembly'|'period'|'break', name: string, time: string, duration: number, sortIndex: number }[] = []; 
        if (assembly) items.push({ type: 'assembly', name: trLocal('Assembly', 'اسمبلی'), time: timeStr(assembly), duration: getDuration(assembly.start, assembly.end), sortIndex: 0 }); 
        periods.forEach((p, i) => { if (i < maxPeriods) { const pName = p.name || num(i + 1); items.push({ type: 'period', name: pName, time: timeStr(p), duration: getDuration(p.start, p.end), sortIndex: (i + 1) * 2 }); } }); 
        breaks.forEach(b => { if (b.beforePeriod <= maxPeriods + 1) { let name = b.name; if (b.name === 'Recess') name = trLocal('Recess', 'تفریح'); else if (b.name === 'Lunch') name = trLocal('Lunch', 'کھانے کا وقفہ'); else if (b.name === 'Jummah') name = trLocal('Jummah', 'جمعہ'); else name = trLocal(b.name, b.name); items.push({ type: 'break', name: name, time: `${b.startTime} - ${b.endTime}`, duration: getDuration(b.startTime, b.endTime), sortIndex: (b.beforePeriod * 2) - 1 }); } }); 
        return items.sort((a, b) => a.sortIndex - b.sortIndex); 
    };
    
    const regItems = getScheduleItems('default'); const friItems = getScheduleItems('friday'); const colA_Items = regItems; const colB_Items = friItems; const colA_Title = trLocal('Regular Days', 'عام ایام'); const colB_Title = trLocal('Jummah Mubarak', 'جمعہ المبارک');
    const durationAlign = isUrdu ? 'left' : 'right'; const periodNameFontSize = isUrdu ? '1.3em' : '1.0em'; const specialNameFontSize = isUrdu ? '1.0em' : '0.85em'; const durationFontSize = isUrdu ? '0.8em' : '0.6em'; const timeFontSize = isUrdu ? '1.2em' : '1.0em';
    const mainHeaderFontSize = isUrdu ? 70 : 35; const subHeaderFontSize = isUrdu ? (customDesign.table.fontSize + 20) : (customDesign.table.fontSize + 5);

    const maxRows = Math.max(colA_Items.length, colB_Items.length); let tableRows = ''; let colBMergeStarted = false; const signatureText = trLocal('Principal Signature', 'دستخط پرنسپل');
    for (let i = 0; i < maxRows; i++) { const itemA = colA_Items[i]; const itemB = colB_Items[i]; let rowHtml = ''; if (itemA) { const isPeriod = itemA.type === 'period'; const bgClass = isPeriod ? 'bg-white' : 'bg-green'; const textClass = 'text-black'; const nameFontSize = isPeriod ? periodNameFontSize : specialNameFontSize; rowHtml += `<td class="${bgClass} ${textClass}" style="font-weight: bold; font-size: ${nameFontSize} !important; vertical-align: middle;">${itemA.name}</td><td class="${bgClass} ${textClass}" style="font-weight: bold; font-size: ${timeFontSize} !important; vertical-align: top;"><div style="display: flex; flex-direction: column; align-items: center; justify-content: ${flexAlign}; height: 100%; line-height: 1.1;"><div style="unicode-bidi: embed;">${itemA.time}</div>${itemA.duration > 0 ? `<div style="font-size: ${durationFontSize} !important; width: 100%; text-align: ${durationAlign}; font-weight: normal; margin-top: 2px;">${itemA.duration} min</div>` : ''}</div></td>`; } else { rowHtml += '<td></td><td></td>'; } if (itemB) { const isPeriod = itemB.type === 'period'; const bgClass = itemB.type === 'period' ? 'bg-white' : 'bg-green'; const textClass = 'text-black'; const nameFontSize = isPeriod ? periodNameFontSize : specialNameFontSize; rowHtml += `<td class="${bgClass} ${textClass}" style="font-weight: bold; font-size: ${nameFontSize} !important; vertical-align: middle;">${itemB.name}</td><td class="${bgClass} ${textClass}" style="font-weight: bold; font-size: ${timeFontSize} !important; vertical-align: top;"><div style="display: flex; flex-direction: column; align-items: center; justify-content: ${flexAlign}; height: 100%; line-height: 1.1;"><div style="unicode-bidi: embed;">${itemB.time}</div>${itemB.duration > 0 ? `<div style="font-size: ${durationFontSize} !important; width: 100%; text-align: ${durationAlign}; font-weight: normal; margin-top: 2px;">${itemA.duration} min</div>` : ''}</div></td>`; } else { if (!colBMergeStarted) { const rowSpan = maxRows - i; rowHtml += `<td colspan="2" rowspan="${rowSpan}" style="border: ${customDesign.table.borderWidth || 3}px solid ${customDesign.table.borderColor}; vertical-align: bottom; text-align: center; padding-bottom: 5px;"><div style="display: inline-block; border-top: 1px solid ${customDesign.table.borderColor}; padding-top: 5px; min-width: 180px; font-size: 1.1em; font-weight: bold; text-align: center; margin-bottom: 5px;">${signatureText}</div></td>`; colBMergeStarted = true; } } tableRows += `<tr>${rowHtml}</tr>`; }
    const customStyles = `<style> .school-timings-table { width: 100%; border-collapse: collapse; text-align: center; font-size: ${customDesign.table.fontSize}px; } .school-timings-table th, .school-timings-table td { border: ${customDesign.table.borderWidth || 3}px solid ${customDesign.table.borderColor}; padding: ${customDesign.table.cellPadding}px; color: ${customDesign.table.bodyColor || '#000000'}; } .main-header { background-color: ${customDesign.table.headerBgColor}; color: ${customDesign.table.headerColor} !important; font-size: ${mainHeaderFontSize}px !important; font-weight: 900; padding: 12px; text-transform: uppercase; } .sub-header { background-color: #E9D5FF; color: #000000; font-weight: bold; font-size: ${subHeaderFontSize}px !important; } .bg-green { background-color: ${customDesign.table.periodColumnBgColor !== '#F3F4F6' ? customDesign.table.periodColumnBgColor : '#86efac'}; } .bg-white { background-color: ${customDesign.table.bodyBgColor}; } .text-black { color: ${customDesign.table.bodyColor || '#000000'}; } </style>`;
    const subHeaderRow = `<tr><th class="sub-header" style="width: 12%">${trLocal('Period', 'پیریڈ')}</th><th class="sub-header" style="width: 38%">${trLocal('Time', 'وقت')}</th><th class="sub-header" style="width: 12%">${trLocal('Period', 'پیریڈ')}</th><th class="sub-header" style="width: 38%">${trLocal('Time', 'وقت')}</th></tr>`;
    const tableHtml = `${customStyles}<table class="school-timings-table"><thead><tr><th colspan="2" class="main-header">${colA_Title}</th><th colspan="2" class="main-header">${colB_Title}</th></tr>${subHeaderRow}</thead><tbody>${tableRows}</tbody></table>`;
    const reportTitle = trLocal('Timetable', 'ٹائم ٹیبل'); 
    return generateReportHTML(schoolConfig, customDesign, reportTitle, lang, tableHtml);
};

export const generateClassTimetableHtml = (classItem: SchoolClass, lang: DownloadLanguage, design: DownloadDesignConfig, teachers: Teacher[], subjects: Subject[], schoolConfig: SchoolConfig): string | string[] => {
    const { en: enT, ur: urT } = translations;
    const inChargeTeacher = teachers.find(t => t.id === classItem.inCharge);
    const tLocal = (key: string) => lang === 'ur' ? (urT as any)[key] : (enT as any)[key]; 
    const alignMap: Record<string, string> = { 'top': 'flex-start', 'middle': 'center', 'bottom': 'flex-end', 'center': 'center' };
    const flexAlign = alignMap[design.table.verticalAlign || 'top'] || 'flex-start';
    const daysPerPage = design.daysPerPage || 7;
    const activeDays = allDays.filter(day => schoolConfig.daysConfig?.[day]?.active ?? true);
    const pages: string[] = [];
    const totalDays = activeDays.length;
    let currentDayIndex = 0;
    const totalPages = Math.ceil(totalDays / daysPerPage);

    const colorMap = new Map<string, string>();
    teachers.forEach((teacher, index) => { colorMap.set(teacher.id, teacherColorNames[index % teacherColorNames.length]); });

    const cardStyle = design.table.cardStyle || 'full';
    const triangleCorner = design.table.triangleCorner || 'bottom-left';
    const outlineWidth = design.table.outlineWidth || 2;
    const mergePatterns = design.table.mergeIdenticalPeriods ?? true;
    const badgeTarget = design.table.badgeTarget || 'subject';

    let triangleStyles = '';
    const triangleSize = 24; 
    if (triangleCorner === 'top-left') {
        triangleStyles = `top: 0; left: 0; border-top: ${triangleSize}px solid currentColor; border-right: ${triangleSize}px solid transparent;`;
    } else if (triangleCorner === 'top-right') {
        triangleStyles = `top: 0; right: 0; border-top: ${triangleSize}px solid currentColor; border-left: ${triangleSize}px solid transparent;`;
    } else if (triangleCorner === 'bottom-right') {
        triangleStyles = `bottom: 0; right: 0; border-bottom: ${triangleSize}px solid currentColor; border-left: ${triangleSize}px solid transparent;`;
    } else { // bottom-left
        triangleStyles = `bottom: 0; left: 0; border-bottom: ${triangleSize}px solid currentColor; border-right: ${triangleSize}px solid transparent;`;
    }

    for (let i = 0; i < totalPages; i++) {
        const chunkDays = activeDays.slice(currentDayIndex, currentDayIndex + daysPerPage);
        currentDayIndex += daysPerPage;
        const maxPeriods = Math.max(...chunkDays.map(day => schoolConfig.daysConfig?.[day]?.periodCount ?? 8));
        const cssColors = `--subject-red-bg: #fee2e2; --subject-red-text: #991b1b; --subject-sky-bg: #e0f2fe; --subject-sky-text: #0369a1; --subject-green-bg: #dcfce7; --subject-green-text: #166534; --subject-yellow-bg: #fef9c3; --subject-yellow-text: #854d0e; --subject-purple-bg: #f3e8ff; --subject-purple-text: #6b21a8; --subject-pink-bg: #fce7f3; --subject-pink-text: #9d174d; --subject-indigo-bg: #e0e7ff; --subject-indigo-text: #3730a3; --subject-teal-bg: #ccfbf1; --subject-teal-text: #134e4a; --subject-orange-bg: #ffedd5; --subject-orange-text: #9a3412; --subject-lime-bg: #ecfccb; --subject-lime-text: #4d7c0f; --subject-cyan-bg: #cffafe; --subject-cyan-text: #0e7490; --subject-emerald-bg: #d1fae5; --subject-emerald-text: #065f46; --subject-fuchsia-bg: #fae8ff; --subject-fuchsia-text: #86198f; --subject-rose-bg: #ffe4e6; --subject-rose-text: #9f1239; --subject-amber-bg: #fef3c7; --subject-amber-text: #92400e; --subject-blue-bg: #dbeafe; --subject-blue-text: #1e40af; --subject-default-bg: #f3f4f6; --subject-default-text: #374151;`;
        
        let cardStyleCss = '';
        if (cardStyle === 'full') {
            cardStyleCss = `background-image: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.1) 100%); box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.08);`;
        } else if (cardStyle === 'outline') {
            cardStyleCss = `background-color: #ffffff !important; border: ${outlineWidth}px solid inherit; box-shadow: none !important;`;
        } else if (cardStyle === 'glass') {
            cardStyleCss = `background: rgba(255, 255, 255, 0.4) !important; backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.02) !important;`;
        } else if (cardStyle === 'gradient') {
            cardStyleCss = `background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.05) 100%) !important; border: none !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;`;
        } else if (cardStyle === 'minimal-left') {
            cardStyleCss = `background-color: #f8fafc !important; border-left: 5px solid currentColor !important; border-top: none !important; border-right: none !important; border-bottom: none !important; box-shadow: none !important; border-radius: 2px !important;`;
        } else if (cardStyle === 'badge') {
            cardStyleCss = `background-color: transparent !important; border: none !important; box-shadow: none !important;`;
        }

        const customStyles = `<style>:root { ${cssColors} } .cell-wrapper { display: flex; flex-direction: column; gap: 2px; width: 100%; height: 100%; box-sizing: border-box; } .glossy-box { flex: 1; min-width: 0; border-radius: 4px; padding: 2px 4px; align-self: stretch; height: 100%; display: flex; flex-direction: column; justify-content: ${flexAlign}; ${cardStyleCss} position: relative; overflow: hidden; box-sizing: border-box; } .subject-text { text-align: left; font-weight: 900; font-size: 1.2em; line-height: 1.1; text-transform: none; letter-spacing: 0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #000000; } .teacher-text { text-align: right; font-size: 1em; font-weight: 700; opacity: 1; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #000000; line-height: 1.1; } .card-triangle { position: absolute; width: 0; height: 0; border-style: solid; ${triangleStyles} z-index: 5; } ${teacherColorNames.map(name => `.${name} { background-color: var(--${name}-bg); color: var(--${name}-text); border-color: var(--${name}-text) !important; } .${name} .subject-text, .${name} .teacher-text, .${name} .subject-name, .${name} .class-list { color: var(--${name}-text) !important; } .${name} .card-triangle { color: var(--${name}-text) !important; }`).join('')} td { padding: ${design.table.cellPadding}px !important; height: auto !important; min-height: 62px; border-color: ${design.table.borderColor} !important; vertical-align: top !important; } table { table-layout: fixed; width: 100%; border-color: ${design.table.borderColor} !important; } .disabled-cell { background-color: #e5e7eb; }</style>`;
        const align1 = lang === 'ur' ? 'right' : 'left'; const align2 = 'center'; const align3 = lang === 'ur' ? 'left' : 'right';
        const detailsHtml = `<div style="width: 100%; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;"><div style="text-align: ${align1}; flex: 1;">${renderText(lang, classItem.nameEn, classItem.nameUr)}</div><div style="text-align: ${align2}; flex: 1;">${inChargeTeacher ? renderText(lang, inChargeTeacher.nameEn, inChargeTeacher.nameUr) : '-'}</div><div style="text-align: ${align3}; flex: 1;">${classItem.roomNumber}</div></div>`;
        const dayHeaders = chunkDays.map(day => { const dayKey = day.toLowerCase(); return `<th>${renderText(lang, (enT as any)[dayKey], (urT as any)[dayKey])}</th>`; }).join('');

        const grid: (null | { html: string, key: string })[][] = Array.from({ length: maxPeriods }, () => Array(chunkDays.length).fill(null));
        for (let pIdx = 0; pIdx < maxPeriods; pIdx++) {
            chunkDays.forEach((day, dIdx) => {
                const periodLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                if (pIdx >= periodLimit) return;
                const periods = classItem.timetable[day as keyof TimetableGridData]?.[pIdx] || [];
                if (periods.length === 0) return;

                const sortedPeriods = [...periods].sort((a, b) => a.subjectId.localeCompare(b.subjectId));
                const key = sortedPeriods.map(p => `${p.subjectId}-${p.teacherId}`).join('|');
                
                const content = sortedPeriods.map(p => {
                    const sub = subjects.find(s => s.id === p.subjectId);
                    const tea = teachers.find(t => t.id === p.teacherId);
                    const subName = sub ? renderText(lang, sub.nameEn, sub.nameUr) : '';
                    const teaName = tea ? renderText(lang, tea.nameEn, tea.nameUr) : '';
                    const colorClass = colorMap.get(p.teacherId) || 'subject-default';
                    const triangleHtml = (cardStyle === 'triangle' || cardStyle === 'full') ? `<div class="card-triangle"></div>` : '';
                    
                    let subjectBadgeStyle = '';
                    let teacherBadgeStyle = '';
                    if (cardStyle === 'badge') {
                        const badgeCss = `background-color: var(--${colorClass}-text); color: #fff !important; padding: 1px 6px; border-radius: 10px; display: inline-block; width: fit-content; margin-bottom: 2px;`;
                        if (badgeTarget === 'teacher') teacherBadgeStyle = badgeCss;
                        else subjectBadgeStyle = badgeCss; // Default to subject
                    }
                    
                    return `<div class="glossy-box ${colorClass}">${triangleHtml}<span class="subject-text" style="${subjectBadgeStyle}" title="${subName.replace(/<[^>]*>/g, '')}">${subName}</span><span class="teacher-text" style="${teacherBadgeStyle}" title="${teaName.replace(/<[^>]*>/g, '')}">${teaName}</span></div>`;
                }).join('');
                grid[pIdx][dIdx] = { html: `<div class="cell-wrapper">${content}</div>`, key };
            });
        }

        let tableRows = '';
        const visited = Array.from({ length: maxPeriods }, () => Array(chunkDays.length).fill(false));
        for (let pIdx = 0; pIdx < maxPeriods; pIdx++) {
            let rowHtml = `<td class="period-col">${pIdx + 1}</td>`;
            for (let dIdx = 0; dIdx < chunkDays.length; dIdx++) {
                if (visited[pIdx][dIdx]) continue;
                const current = grid[pIdx][dIdx];
                const day = chunkDays[dIdx];
                const periodLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                if (pIdx >= periodLimit) {
                    rowHtml += `<td class="disabled-cell"></td>`;
                    visited[pIdx][dIdx] = true;
                    continue;
                }
                if (!current) {
                    rowHtml += `<td></td>`;
                    visited[pIdx][dIdx] = true;
                    continue;
                }

                let rowspan = 1;
                if (mergePatterns) {
                    while (pIdx + rowspan < maxPeriods) {
                        const next = grid[pIdx + rowspan][dIdx];
                        const nextDayLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                        if (pIdx + rowspan < nextDayLimit && next && next.key === current.key) {
                            rowspan++;
                        } else {
                            break;
                        }
                    }
                }
                for (let r = 0; r < rowspan; r++) visited[pIdx + r][dIdx] = true;
                rowHtml += `<td ${rowspan > 1 ? `rowspan="${rowspan}"` : ''} >${current.html}</td>`;
            }
            tableRows += `<tr>${rowHtml}</tr>`;
        }

        const colGroupHtml = `<colgroup><col style="width: ${design.table.periodColumnWidth}px">${chunkDays.map(() => '<col style="width: auto">').join('')}</colgroup>`;
        const tableHtml = `${customStyles}<table>${colGroupHtml}<thead><tr><th class="period-col"></th>${dayHeaders}</tr></thead><tbody>${tableRows}</tbody></table>`;
        pages.push(generateReportHTML(schoolConfig, design, `${tLocal('classTimetable')}`, lang, tableHtml, detailsHtml, i + 1, totalPages));
    }
    return pages.length === 1 ? pages[0] : pages; 
};

export const generateTeacherTimetableHtml = (teacher: Teacher, lang: DownloadLanguage, design: DownloadDesignConfig, classes: SchoolClass[], subjects: Subject[], schoolConfig: SchoolConfig, adjustments: Record<string, Adjustment[]>, teachers: Teacher[]): string | string[] => {
    const { en: enT, ur: urT } = translations;
    const tLocal = (key: string) => lang === 'ur' ? (urT as any)[key] : (enT as any)[key];
    const alignMap: Record<string, string> = { 'top': 'flex-start', 'middle': 'center', 'bottom': 'flex-end', 'center': 'center' };
    const flexAlign = alignMap[design.table.verticalAlign || 'top'] || 'flex-start';
    const daysPerPage = design.daysPerPage || 7;
    const activeDays = allDays.filter(day => schoolConfig.daysConfig?.[day]?.active ?? true);
    const pages: string[] = [];
    const totalDays = activeDays.length;
    let currentDayIndex = 0;
    const totalPages = Math.ceil(totalDays / daysPerPage);

    const cardStyle = design.table.cardStyle || 'full';
    const triangleCorner = design.table.triangleCorner || 'bottom-left';
    const outlineWidth = design.table.outlineWidth || 2;
    const mergePatterns = design.table.mergeIdenticalPeriods ?? true;
    const badgeTarget = design.table.badgeTarget || 'subject';

    let triangleStyles = '';
    const triangleSize = 24;
    if (triangleCorner === 'top-left') {
        triangleStyles = `top: 0; left: 0; border-width: ${triangleSize}px ${triangleSize}px 0 0; border-color: currentColor transparent transparent transparent;`;
    } else if (triangleCorner === 'top-right') {
        triangleStyles = `top: 0; right: 0; border-width: 0 ${triangleSize}px ${triangleSize}px 0; border-color: transparent currentColor transparent transparent;`;
    } else if (triangleCorner === 'bottom-right') {
        triangleStyles = `bottom: 0; right: 0; border-width: 0 0 ${triangleSize}px ${triangleSize}px; border-color: transparent transparent currentColor transparent;`;
    } else { // bottom-left
        triangleStyles = `bottom: 0; left: 0; border-width: ${triangleSize}px 0 0 ${triangleSize}px; border-color: transparent transparent transparent currentColor;`;
    }

    const getCombinationColor = (p: Period) => { const key = `${p.classId}-${p.subjectId}-${p.jointPeriodId || ''}`; let hash = 0; for (let i = 0; i < key.length; i++) hash = key.charCodeAt(i) + ((hash << 5) - hash); return teacherColorNames[Math.abs(hash) % teacherColorNames.length]; };

    for (let i = 0; i < totalPages; i++) {
        const chunkDays = activeDays.slice(currentDayIndex, currentDayIndex + daysPerPage);
        currentDayIndex += daysPerPage;
        const maxPeriods = Math.max(...chunkDays.map(day => schoolConfig.daysConfig?.[day]?.periodCount ?? 8));
        const stats = calculateWorkloadStats(teacher.id, classes, adjustments, {}, undefined, undefined, schoolConfig);
        const workloadLabel = `${stats.weeklyPeriods} ${stats.weeklyPeriods === 1 ? tLocal('period') : tLocal('periods')}`;
        const cssColors = `--subject-red-bg: #fee2e2; --subject-red-text: #991b1b; --subject-sky-bg: #e0f2fe; --subject-sky-text: #0369a1; --subject-green-bg: #dcfce7; --subject-green-text: #166534; --subject-yellow-bg: #fef9c3; --subject-yellow-text: #854d0e; --subject-purple-bg: #f3e8ff; --subject-purple-text: #6b21a8; --subject-pink-bg: #fce7f3; --subject-pink-text: #9d174d; --subject-indigo-bg: #e0e7ff; --subject-indigo-text: #3730a3; --subject-teal-bg: #ccfbf1; --subject-teal-text: #134e4a; --subject-orange-bg: #ffedd5; --subject-orange-text: #9a3412; --subject-lime-bg: #ecfccb; --subject-lime-text: #4d7c0f; --subject-cyan-bg: #cffafe; --subject-cyan-text: #0e7490; --subject-emerald-bg: #d1fae5; --subject-emerald-text: #065f46; --subject-fuchsia-bg: #fae8ff; --subject-fuchsia-text: #86198f; --subject-rose-bg: #ffe4e6; --subject-rose-text: #9f1239; --subject-amber-bg: #fef3c7; --subject-amber-text: #92400e; --subject-blue-bg: #dbeafe; --subject-blue-text: #1e40af; --subject-default-bg: #f3f4f6; --subject-default-text: #374151;`;
        
        let cardStyleCss = '';
        if (cardStyle === 'full') {
            cardStyleCss = `border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 2px 5px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.5), inset 0 0 10px rgba(255,255,255,0.2); background-image: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.02) 100%);`;
        } else if (cardStyle === 'outline') {
            cardStyleCss = `background-color: #ffffff !important; border: ${outlineWidth}px solid inherit; box-shadow: none !important;`;
        } else if (cardStyle === 'glass') {
            cardStyleCss = `background: rgba(255, 255, 255, 0.4) !important; backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.02) !important;`;
        } else if (cardStyle === 'gradient') {
            cardStyleCss = `background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.05) 100%) !important; border: none !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;`;
        } else if (cardStyle === 'minimal-left') {
            cardStyleCss = `background-color: #f8fafc !important; border-left: 5px solid currentColor !important; border-radius: 2px !important; box-shadow: none !important; border-top: none !important; border-right: none !important; border-bottom: none !important;`;
        } else if (cardStyle === 'badge') {
            cardStyleCss = `background-color: transparent !important; border: none !important; box-shadow: none !important;`;
        }

        const customStyles = `<style>:root { ${cssColors} } .cell-content { display: flex; flex-direction: column; height: 100%; width: 100%; justify-content: center; gap: 2px; box-sizing: border-box; } .teacher-card { flex: 1; width: 100%; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; gap: 2px; box-sizing: border-box; overflow: hidden; ${cardStyleCss} padding: 4px 6px; position: relative; height: 100%; } .teacher-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 45%; background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0)); pointer-events: none; z-index: 0; } .class-list { font-weight: 900; font-size: 1.6em; text-align: left; line-height: 1.0; margin-top: 2px; text-transform: none; color: #000000; text-shadow: 0 1px 0 rgba(255,255,255,0.5); z-index: 1; position: relative; } .subject-name { font-size: 1.35em; text-align: right; line-height: 1.1; font-weight: 700; margin-bottom: 2px; color: #000000; text-shadow: 0 1px 0 rgba(255,255,255,0.5); z-index: 1; position: relative; } .card-triangle { position: absolute; width: 0; height: 0; border-style: solid; ${triangleStyles} z-index: 5; } ${teacherColorNames.map(name => `.${name} { background-color: var(--${name}-bg); color: var(--${name}-text); border-color: var(--${name}-text) !important; } .${name} .subject-text, .${name} .teacher-text, .${name} .subject-name, .${name} .class-list { color: var(--${name}-text) !important; } .${name} .card-triangle { color: var(--${name}-text) !important; }`).join('')} td { padding: ${design.table.cellPadding}px !important; height: auto !important; min-height: 60px; border-color: ${design.table.borderColor} !important; vertical-align: top !important; } table { table-layout: fixed; width: 100%; border-spacing: 0; border-color: ${design.table.borderColor} !important; } .disabled-cell { background-color: #e5e7eb; }</style>`;
        const align1 = lang === 'ur' ? 'right' : 'left'; const align2 = 'center'; const align3 = lang === 'ur' ? 'left' : 'right';
        const detailsHtml = `<div style="width: 100%; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;"><div style="text-align: ${align1}; flex: 1;"># ${teacher.serialNumber ?? '-'}</div><div style="text-align: ${align2}; flex: 1;">${renderText(lang, teacher.nameEn, teacher.nameUr)}</div><div style="text-align: ${align3}; flex: 1;">${workloadLabel}</div></div>`;
        const dayHeaders = chunkDays.map(day => `<th>${renderText(lang, (enT as any)[day.toLowerCase()], (urT as any)[day.toLowerCase()])}</th>`).join('');

        const grid: (null | { html: string, key: string })[][] = Array.from({ length: maxPeriods }, () => Array(chunkDays.length).fill(null));
        for (let pIdx = 0; pIdx < maxPeriods; pIdx++) {
            chunkDays.forEach((day, dIdx) => {
                const periodLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                if (pIdx >= periodLimit) return;
                const periods: any[] = [];
                classes.forEach(c => {
                    c.timetable[day as keyof TimetableGridData]?.[pIdx]?.forEach(p => {
                        if (p.teacherId === teacher.id) periods.push({ ...p, classNameEn: c.nameEn, classNameUr: c.nameUr });
                    });
                });
                if (periods.length === 0) return;

                const grouped = new Map<string, { subjectId: string, classId: string, jointPeriodId: string, classNames: Set<string>, firstPeriod: Period }>();
                periods.forEach(p => {
                    const groupKey = `${p.subjectId}-${p.classId}-${p.jointPeriodId || ''}`;
                    if (!grouped.has(groupKey)) grouped.set(groupKey, { subjectId: p.subjectId, classId: p.classId, jointPeriodId: p.jointPeriodId || '', classNames: new Set(), firstPeriod: p });
                    grouped.get(groupKey)!.classNames.add(renderText(lang, p.classNameEn, p.classNameUr));
                });
                const sortedGroupKeys = Array.from(grouped.keys()).sort();
                const key = sortedGroupKeys.map(k => { const g = grouped.get(k)!; return `${k}-${Array.from(g.classNames).sort().join(',')}`; }).join('|');

                const cards = sortedGroupKeys.map(gk => {
                    const group = grouped.get(gk)!;
                    const sub = subjects.find(s => s.id === group.subjectId);
                    const subjectName = sub ? renderText(lang, sub.nameEn, sub.nameUr) : '';
                    const classList = Array.from(group.classNames).join(', ');
                    const colorClass = getCombinationColor(group.firstPeriod);
                    const triangleHtml = (cardStyle === 'triangle' || cardStyle === 'full') ? `<div class="card-triangle"></div>` : '';
                    
                    let subjectBadgeStyle = '';
                    let classBadgeStyle = '';
                    if (cardStyle === 'badge') {
                        const badgeCss = `background-color: var(--${colorClass}-text); color: #fff !important; padding: 1px 6px; border-radius: 10px; display: inline-block; width: fit-content; margin-bottom: 2px;`;
                        if (badgeTarget === 'class') classBadgeStyle = badgeCss;
                        else subjectBadgeStyle = badgeCss; // default subject
                    }

                    return `<div class="teacher-card ${colorClass}">${triangleHtml}<div class="class-list" style="${classBadgeStyle}">${classList}</div><div class="subject-name" style="${subjectBadgeStyle}">${subjectName}</div></div>`;
                }).join('');
                grid[pIdx][dIdx] = { html: `<div class="cell-content">${cards}</div>`, key };
            });
        }

        let tableRows = '';
        const visited = Array.from({ length: maxPeriods }, () => Array(chunkDays.length).fill(false));
        for (let pIdx = 0; pIdx < maxPeriods; pIdx++) {
            let rowHtml = `<td class="period-col">${pIdx + 1}</td>`;
            for (let dIdx = 0; dIdx < chunkDays.length; dIdx++) {
                if (visited[pIdx][dIdx]) continue;
                const current = grid[pIdx][dIdx];
                const day = chunkDays[dIdx];
                const periodLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                if (pIdx >= periodLimit) {
                    rowHtml += `<td class="disabled-cell"></td>`;
                    visited[pIdx][dIdx] = true;
                    continue;
                }
                if (!current) {
                    rowHtml += `<td></td>`;
                    visited[pIdx][dIdx] = true;
                    continue;
                }

                let rowspan = 1;
                if (mergePatterns) {
                    while (pIdx + rowspan < maxPeriods) {
                        const next = grid[pIdx + rowspan][dIdx];
                        const nextDayLimit = schoolConfig.daysConfig?.[day]?.periodCount ?? 8;
                        if (pIdx + rowspan < nextDayLimit && next && next.key === current.key) {
                            rowspan++;
                        } else {
                            break;
                        }
                    }
                }
                for (let r = 0; r < rowspan; r++) visited[pIdx + r][dIdx] = true;
                rowHtml += `<td ${rowspan > 1 ? `rowspan="${rowspan}"` : ''} >${current.html}</td>`;
            }
            tableRows += `<tr>${rowHtml}</tr>`;
        }

        const colGroupHtml = `<colgroup><col style="width: ${design.table.periodColumnWidth}px">${chunkDays.map(() => '<col style="width: auto">').join('')}</colgroup>`;
        const tableHtml = `${customStyles}<table>${colGroupHtml}<thead><tr><th class="period-col"></th>${dayHeaders}</tr></thead><tbody>${tableRows}</tbody></table>`;
        pages.push(generateReportHTML(schoolConfig, design, `${tLocal('teacherTimetable')}`, lang, tableHtml, detailsHtml, i + 1, totalPages));
    }
    return pages.length === 1 ? pages[0] : pages;
};

// --- New Functions to fix missing exports ---

export const generateAdjustmentsReportHtml = (
    t: any,
    lang: DownloadLanguage,
    design: DownloadDesignConfig,
    adjustments: Adjustment[],
    teachers: Teacher[],
    classes: SchoolClass[],
    subjects: Subject[],
    schoolConfig: SchoolConfig,
    date: string,
    absentTeacherIds: string[],
    signature?: string
): string | string[] => {
    // Basic implementation for report generation. 
    // In a real scenario, you would build the HTML structure for the adjustments table.
    
    const title = lang === 'ur' ? translations.ur.dailyAdjustments : translations.en.dailyAdjustments;
    const dateFormatted = new Date(date).toLocaleDateString(lang === 'ur' ? 'ur-PK' : 'en-GB');
    
    let content = `<h3>Date: ${dateFormatted}</h3>`;
    
    // Add absent teachers list
    if (absentTeacherIds.length > 0) {
        const absentNames = absentTeacherIds.map(id => {
            const teacher = teachers.find(t => t.id === id);
            return teacher ? renderText(lang, teacher.nameEn, teacher.nameUr) : '';
        }).join(', ');
        content += `<p><strong>Absent Teachers:</strong> ${absentNames}</p>`;
    }

    // Add adjustments table
    if (adjustments.length > 0) {
        content += `<table><thead><tr><th>Period</th><th>Class</th><th>Subject</th><th>Original Teacher</th><th>Substitute</th></tr></thead><tbody>`;
        adjustments.sort((a,b) => a.periodIndex - b.periodIndex).forEach(adj => {
            const cls = classes.find(c => c.id === adj.classId);
            const sub = subjects.find(s => s.id === adj.subjectId);
            const orig = teachers.find(t => t.id === adj.originalTeacherId);
            const subst = teachers.find(t => t.id === adj.substituteTeacherId);
            
            content += `<tr>
                <td>${adj.periodIndex + 1}</td>
                <td>${cls ? renderText(lang, cls.nameEn, cls.nameUr) : ''}</td>
                <td>${sub ? renderText(lang, sub.nameEn, sub.nameUr) : ''}</td>
                <td>${orig ? renderText(lang, orig.nameEn, orig.nameUr) : ''}</td>
                <td>${subst ? renderText(lang, subst.nameEn, subst.nameUr) : ''}</td>
            </tr>`;
        });
        content += `</tbody></table>`;
    } else {
        content += `<p>No adjustments recorded.</p>`;
    }

    if (signature) {
        content += `<div style="margin-top: 40px; text-align: right;">
            <img src="${signature}" style="height: 60px;" /><br/>
            <span>Principal Signature</span>
        </div>`;
    }

    return generateReportHTML(schoolConfig, design, title, lang, content);
};

export const generateAdjustmentsExcel = (
    t: any,
    adjustments: Adjustment[],
    teachers: Teacher[],
    classes: SchoolClass[],
    subjects: Subject[],
    date: string
) => {
    const csv = ['Date,Period,Class,Subject,Original Teacher,Substitute Teacher'];
    adjustments.forEach(adj => {
        const cls = classes.find(c => c.id === adj.classId);
        const sub = subjects.find(s => s.id === adj.subjectId);
        const orig = teachers.find(t => t.id === adj.originalTeacherId);
        const subst = teachers.find(t => t.id === adj.substituteTeacherId);
        
        csv.push(toCsvRow([
            date,
            adj.periodIndex + 1,
            cls ? cls.nameEn : '',
            sub ? sub.nameEn : '',
            orig ? orig.nameEn : '',
            subst ? subst.nameEn : ''
        ]));
    });
    downloadCsv(csv.join('\n'), `Adjustments_${date}.csv`);
};

export const generateAttendanceReportHtml = (
    t: any,
    lang: DownloadLanguage,
    design: DownloadDesignConfig,
    classes: SchoolClass[],
    teachers: Teacher[],
    schoolConfig: SchoolConfig,
    date: string,
    adjustments: any,
    leaveDetails: any,
    attendance: Record<string, AttendanceData>
): string => {
    const title = lang === 'ur' ? translations.ur.attendanceReport : translations.en.attendanceReport;
    const dateFormatted = new Date(date).toLocaleDateString(lang === 'ur' ? 'ur-PK' : 'en-GB');
    
    let content = `<h3>Date: ${dateFormatted}</h3>`;
    content += `<table><thead><tr><th>Class</th><th>Total</th><th>Present</th><th>Absent</th><th>Leave</th><th>Sick</th><th>Submitted By</th></tr></thead><tbody>`;
    
    let totalStudents = 0;
    let totalPresent = 0;
    let totalAbsent = 0;

    classes.forEach(c => {
        if (c.id === 'non-teaching-duties') return;
        const record = attendance[c.id];
        if (record) {
            totalStudents += c.studentCount;
            totalPresent += record.present;
            totalAbsent += record.absent;
            content += `<tr>
                <td>${renderText(lang, c.nameEn, c.nameUr)}</td>
                <td>${c.studentCount}</td>
                <td>${record.present}</td>
                <td>${record.absent}</td>
                <td>${record.leave}</td>
                <td>${record.sick}</td>
                <td>${record.submittedBy || '-'}</td>
            </tr>`;
        } else {
            content += `<tr>
                <td>${renderText(lang, c.nameEn, c.nameUr)}</td>
                <td>${c.studentCount}</td>
                <td colspan="5" style="text-align:center; color: #999;">Not Submitted</td>
            </tr>`;
        }
    });
    
    content += `<tr style="font-weight:bold; background-color: #f3f4f6;">
        <td>Total</td>
        <td>${totalStudents}</td>
        <td>${totalPresent}</td>
        <td>${totalAbsent}</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
    </tr>`;
    
    content += `</tbody></table>`;
    
    const percentage = totalStudents > 0 ? ((totalPresent / totalStudents) * 100).toFixed(1) : '0';
    content += `<p><strong>Attendance Percentage:</strong> ${percentage}%</p>`;

    return generateReportHTML(schoolConfig, design, title, lang, content);
};

export const generateAttendanceReportExcel = (
    t: any,
    lang: DownloadLanguage,
    classes: SchoolClass[],
    teachers: Teacher[],
    date: string,
    adjustments: any,
    leaveDetails: any,
    attendance: Record<string, AttendanceData>
) => {
    const csv = ['Date,Class,Total Students,Present,Absent,Leave,Sick,Submitted By'];
    
    classes.forEach(c => {
        if (c.id === 'non-teaching-duties') return;
        const record = attendance[c.id];
        if (record) {
            csv.push(toCsvRow([
                date,
                lang === 'ur' ? c.nameUr : c.nameEn,
                c.studentCount,
                record.present,
                record.absent,
                record.leave,
                record.sick,
                record.submittedBy || ''
            ]));
        } else {
            csv.push(toCsvRow([
                date,
                lang === 'ur' ? c.nameUr : c.nameEn,
                c.studentCount,
                '', '', '', '', 'Not Submitted'
            ]));
        }
    });
    
    downloadCsv(csv.join('\n'), `Attendance_Report_${date}.csv`);
};
